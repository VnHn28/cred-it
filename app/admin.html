<!DOCTYPE html>
<html>
    <head>
        <title>管理者介面</title>
        <meta charset="UTF-8">
        <!-- 響應式網站 -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- bootstrap -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
        
         <!-- adminlte上面找template-->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.min.css" />
        <!-- 自定義卷軸 -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/overlayscrollbars/1.13.1/css/OverlayScrollbars.min.css" />
        <link href="css/owner.css" rel="stylesheet"/>
        <link rel="icon" type="image/png" sizes="16x16" href="img/pepehype.png"> // Favicon
        <!-- jquery函式庫 -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <!-- bootstrap函式庫 popper買bootstrap送popper-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.0-beta1/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
        <!-- adminlte上面找template-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/js/adminlte.min.js"></script>
        <!-- font awesome -->
            <!-- font awesome -->
        <script src="https://kit.fontawesome.com/943e78bd4b.js" crossorigin="anonymous"></script>
        
    </head>

    <body class="sidebar-mini layout-fixed">
        <header></header>
        <div class="wrapper">
            <nav class="main-header navbar navbar-expand navbar-white navbar-light">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
                    </li>
                </ul>
            </nav>

            <aside class="main-sidebar sidebar-dark-primary elevation-4">
                <div class="sidebar">
                    <nav class="mt-2">
                        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
                            <li class="nav-item">
                                <a href="client.html" class="nav-link" id="client_href">
                                    <i class="nav-icon fas fa-file-alt"></i>
                                    <p>用戶</p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="bank.html" class="nav-link" id="bank_href">
                                    <i class="nav-icon fas fa-wallet"></i>
                                    <p>銀行</p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="admin.html" class="nav-link active" id="admin_href">
                                    <i class="nav-icon fas fa-tools"></i>
                                    <p>管理者</p>
                                </a>
                            </li>                   
                        </ul>
                    </nav>
                </div>
            </aside>
        <section id=Mainpage>
            <div class="main">
                <div class="col-md-6">
                    <div class="card card-info">
                        <div class="card-header">
                            <h3 class="card-title">設定用戶/銀行</h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="col-12">
                                    <strong>您的錢包帳戶</strong>
                                    <input type="text" class="form-control" id="account" readonly />
                                </div>
                                <div class="col-12">
                                    <strong>鏈</strong>
                                    <input type="text" class="form-control" id="chain" readonly />
                                </div>
                                <div class="col-md-12">
                                    <label for="contract_address">合約位址</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="contract_address" placeholder="請輸入合約位址" value="0x84feA55448731f62F4C8FfC7AD3482396F44B914" />
                                        <div class="input-group-prepend">
                                            <button type="button" class="btn btn-warning" id="contract_address_btn">連結</button>
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 1%;"></div>
                                <div class="col-md-12">
                                    <div class="row">
                                        <div class="col-6">
                                            <strong>要設定的使用者位址</strong>
                                            <input type="text" class="form-control" id="Address"placeholder="請輸入使用者位址" />
                                        </div>
                                        <div class="col-6">
                                            <strong>要設定的使用者姓名</strong>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="Name" placeholder="請輸入使用者姓名" />                            
                                            </div>
                                        </div>
                                        <div class="setapproval">
                                            <div>
                                                <strong>要設定的角色</strong>
                                                <div>
                                                    <input class="check" type="radio" id="user" name="drone" value="1">
                                                    <label for="bank"><h4>用戶</h4></label>
                                                </div>                      
                                                <div>
                                                    <input class="check" type="radio" id="bank" name="drone" value="2">
                                                    <label for="bank"><h4>銀行</h4></label>
                                                </div>
                                                <span>
                                                    <button type="button" id="set_role_btn" class="btn btn-warning">確定</button>
                                                </span>  
                                            </div>       
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>    

        <footer></footer>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.3/web3.min.js"></script>
        <script src="./js/contract.js"></script>
        <script src="./js/abi.js"></script>
        <script>
            var credit_contract;
            var contract_address = $("#contract_address").val();

             $(async function () {   //網頁載入後第一個觸發的函式
                console.log('ethereum', window.ethereum)   //window就是瀏覽器
                if (typeof window.ethereum !== 'undefined') {           //檢查瀏覽器是否已安裝MetaMask
                    try {
                        var accounts = await ethereum.request({ method: 'eth_requestAccounts' }) //MetaMask請求用戶授權, 連結會登入到MetaMask
                        console.log('accounts', accounts);
                        web3 = new Web3(window.ethereum);

                        updateWeb3Account(accounts[0])
                    } catch (error) {
                        alert(error.message)
                    }
                } else {
                    alert('未安裝 MetaMask!')
                }
            })


            //MetaMask切換帳戶
            ethereum.on('accountsChanged', function (accounts) {
                console.log('accountsChanged', accounts)
                updateWeb3Account(accounts[0])
            })
            //更新帳戶資料
            function updateWeb3Account(account) {
                web3.eth.defaultAccount = account;
                $('#account').val(account)
            }
            //MetaMask連結區塊鏈
            ethereum.on('connect', function (connectInfo) {
                console.log('connect', connectInfo)
                let chain = '(' + connectInfo.chainId + ')' + getChainNameByID(connectInfo.chainId)
                $('#chain').val(chain)
            })

            //MetaMask切換網路
            ethereum.on('chainChanged', function (chainId) {
                console.log('chainChanged', chainId)
                window.location.reload()   //網頁重整
            })

            //根據Chain ID取得網路名稱
            function getChainNameByID(chainid) {
                switch (chainid) {
                    case '0x1':
                        return 'Ethereum Main Network'
                    case '0x3':
                        return 'Ropsten Test Network'
                    case '0x4':
                        return 'Rinkeby Test Network'
                    case '0x5':
                        return 'Goerli Test Network'
                    case '0x2a':
                        return 'Kovan Test Network'
                    default:
                        return 'Unknown Network'
                }
            }

            //create Contract
            $("#contract_address_btn").click(async function(){
                var contract_address = $("#contract_address").val();
                createContract(contract_address);
                $("#contract_address").attr('readonly', true);
                $("#contract_address_btn").attr('disabled', true);
                console.log("Contract is at:" , contract_address);
            });

            // Set Role
            $("#set_role_btn").click(async function(){
                var userRole = $('input[name="drone"]:checked').val();
                var userAddress = $('#Address').val();
                var userName = $('#Name').val();

                await contract_setRole(credit_contract, userAddress, userName, userRole);
                //console.log("Contract is at:" , credit_contract);
                console.log("The role is", userRole, 
                            ". The address is: ", userAddress, 
                            " The name is: ", userName);
            });

            function createContract(address){
                credit_contract = new web3.eth.Contract(Credit_ABI, address);
                return credit_contract;
            }

            async function setRole(credit_contract, userAddress, userName, userRole){
                var setRole = await contracts_setRole(credit_contract, userAddress, userName, userRole);
                
            }
        </script>
    </body>

    
</html>
